<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4">License Management Dashboard</h2>

  <!-- Step-by-step creation flow -->
  <div class="mb-3">
    <label class="form-label">1. Select or Create Company</label>
    <select id="companySelect" class="form-select"></select>
  </div>
  <div class="mb-3">
    <label class="form-label">2. Select or Create Surveyor</label>
    <select id="surveyorSelect" class="form-select" disabled></select>
  </div>
  <div class="mb-3">
    <label class="form-label">3. Select or Create Computer</label>
    <select id="computerSelect" class="form-select" disabled></select>
  </div>
  <div class="mb-3">
    <label class="form-label">4. Create License</label>
    <form id="licenseForm">
      <input type="date" name="expire_date" class="form-control mb-2" required>
      <select name="paid" class="form-select mb-2">
        <option value="true">Paid</option>
        <option value="false">Not Paid</option>
      </select>
      <button class="btn btn-success" type="submit">Create License</button>
    </form>
  </div>

  <hr>

  <h4>All Licenses</h4>
  <table class="table table-bordered">
    <thead>
      <tr><th>Company</th><th>Surveyor</th><th>Computer</th><th>Paid</th><th>Expires</th><th>Status</th></tr>
    </thead>
    <tbody id="licenseTable"></tbody>
  </table>
</div>

<script>
  async function fetchOptions() {
    const res = await fetch('/api/options');
    return res.json();
  }

  async function loadTable() {
    const res = await fetch('/api/all');
    const data = await res.json();
    const tbody = document.getElementById('licenseTable');
    tbody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.company_name}</td>
        <td>${row.surveyor_name}</td>
        <td>${row.computer_serial_number}</td>
        <td>${row.paid ? 'Yes' : 'No'}</td>
        <td>${row.expire_date}</td>
        <td>${row.status ? '✅' : '❌'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function populateFormSteps() {
    const { companies, surveyors, computers } = await fetchOptions();
    const companySelect = document.getElementById('companySelect');
    const surveyorSelect = document.getElementById('surveyorSelect');
    const computerSelect = document.getElementById('computerSelect');

    companySelect.innerHTML = '<option value="">Select Company</option>';
    companies.forEach(c => companySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);

    companySelect.addEventListener('change', () => {
      surveyorSelect.disabled = false;
      const companyId = companySelect.value;
      const filteredSurveyors = surveyors.filter(s => s.company_id == companyId);
      surveyorSelect.innerHTML = '<option value="">Select Surveyor</option>';
      filteredSurveyors.forEach(s => surveyorSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
    });

    surveyorSelect.addEventListener('change', () => {
      computerSelect.disabled = false;
      const surveyorId = surveyorSelect.value;
      const filteredComputers = computers.filter(c => c.surveyor_id == surveyorId);
      computerSelect.innerHTML = '<option value="">Select Computer</option>';
      filteredComputers.forEach(c => computerSelect.innerHTML += `<option value="${c.id}">${c.serial_number}</option>`);
    });
  }

  document.getElementById('licenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const computerId = document.getElementById('computerSelect').value;
    const form = new FormData(e.target);
    form.append('computer_id', computerId);
    await fetch('/api/create/license', { method: 'POST', body: form });
    e.target.reset();
    await loadTable();
  });

  populateFormSteps();
  loadTable();
</script>
</body>
</html>